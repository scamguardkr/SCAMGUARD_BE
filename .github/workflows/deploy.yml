name: Deploy to EC2

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'corretto'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Create application.yml
        run: |
          mkdir -p src/main/resources
          cat > src/main/resources/application.yml << EOF
          spring:
            ai:
              openai:
                api-key: ${{ secrets.OPENAI_API_KEY }}
                chat:
                  options:
                    model: gpt-5-nano
                    temperature: 1
            application:
              name: scamguard
            web:
              resources:
                add-mappings: false
            flyway:
              enabled: true
              baseline-on-migrate: true
              locations: classpath:db/migration
            data:
              redis:
                port: 6379
                host: localhost
              mongodb:
                host: localhost
                port: 27017
                database: scamguard
            jpa:
              properties:
                hibernate:
                  default_batch_fetch_size: 100
                  show_sql: false
                  format_sql: false
              hibernate:
                ddl-auto: none
            servlet:
              multipart:
                max-file-size: 10MB
                max-request-size: 10MB
            datasource:
              driver-class-name: com.mysql.cj.jdbc.Driver
              url: ${{ secrets.DB_URL }}
              username: ${{ secrets.DB_USERNAME }}
              password: ${{ secrets.DB_PASSWORD }}
          
          jwt:
            secret-key: ${{ secrets.JWT_SECRET_KEY }}
            access-token:
              expiration-time: 1200000
            refresh-token:
              expiration-time: 604800000
          
          server:
            tomcat:
              max-http-form-post-size: 10MB
            servlet:
              encoding:
                force-response: true
          
          logging:
            level:
              kr.cse.scamguard: INFO
              org:
                springframework:
                  security: WARN
          
          swagger:
            server-url: http://${{ secrets.EC2_HOST }}
          
          springdoc:
            writer-with-default-pretty-printer: true
          
          cors:
            allowed-origins: http://localhost:3000,http://127.0.0.1:3000
          
          app:
            ai:
              openrouter:
                api-key: ${{ secrets.OPENROUTER_API_KEY }}
                base-url: https://openrouter.ai/api
                model: deepseek/deepseek-r1-0528:free
          EOF

      - name: Build with Gradle
        run: ./gradlew clean build -x test

      - name: Get GitHub Actions IP
        id: ip
        uses: haythem/public-ip@v1.2

      - name: Add GitHub Actions IP to Security Group
        run: |
          aws ec2 authorize-security-group-ingress \
            --group-id ${{ secrets.AWS_SG_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr ${{ steps.ip.outputs.ipv4 }}/32
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ap-northeast-2

      - name: Wait for Security Group to Update
        run: sleep 10

      - name: Copy JAR to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          source: "build/libs/*.jar"
          target: "/opt/scamguard/"
          strip_components: 2

      - name: Execute remote ssh commands
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 60s
          debug: true
          script: |
            sudo mv -f /opt/scamguard/*.jar /opt/scamguard/app.jar
            
            # 서비스 재시작
            sudo systemctl stop scamguard || true
            sudo systemctl start scamguard
            sudo systemctl status scamguard

      - name: Remove GitHub Actions IP from Security Group
        if: always()
        run: |
          aws ec2 revoke-security-group-ingress \
            --group-id ${{ secrets.AWS_SG_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr ${{ steps.ip.outputs.ipv4 }}/32
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ap-northeast-2
