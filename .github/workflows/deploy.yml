name: Deploy to EC2

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'corretto'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Create application.yml
        run: |
          mkdir -p src/main/resources
          cat > src/main/resources/application.yml << EOF
          spring:
            ai:
              openai:
                api-key: ${{ secrets.OPENAI_API_KEY }}
                chat:
                  options:
                    model: gpt-5-nano
                    temperature: 1
              google:
                genai:
                  embedding:
                    api-key: ${{ secrets.GOOGLE_API_KEY }}
                    text:
                      options:
                        model: gemini-embedding-001
                        task-type: RETRIEVAL_DOCUMENT
                        dimensions: 3072
              model:
                embedding:
                  text: google-genai
            application:
              name: scamguard
            web:
              resources:
                add-mappings: false
            flyway:
              enabled: true
              baseline-on-migrate: true
              locations: classpath:db/migration
            data:
              redis:
                port: 6379
                host: localhost
              mongodb:
                host: localhost
                port: 27017
                database: scamguard
            jpa:
              properties:
                hibernate:
                  default_batch_fetch_size: 100
                  show_sql: false
                  format_sql: false
              hibernate:
                ddl-auto: none
            servlet:
              multipart:
                max-file-size: 10MB
                max-request-size: 10MB
            datasource:
              driver-class-name: com.mysql.cj.jdbc.Driver
              url: ${{ secrets.DB_URL }}
              username: ${{ secrets.DB_USERNAME }}
              password: ${{ secrets.DB_PASSWORD }}
          
          jwt:
            secret-key: ${{ secrets.JWT_SECRET_KEY }}
            access-token:
              expiration-time: 1200000
            refresh-token:
              expiration-time: 604800000
          
          server:
            tomcat:
              max-http-form-post-size: 10MB
            servlet:
              encoding:
                force-response: true
          
          logging:
            level:
              kr.cse.scamguard: INFO
              org:
                springframework:
                  security: WARN
          
          swagger:
            server-url: http://${{ secrets.EC2_HOST }}
          
          springdoc:
            writer-with-default-pretty-printer: true
          
          cors:
            allowed-origins: http://localhost:3000,http://127.0.0.1:3000,http://localhost:5173,http://127.0.0.1:5173,https://web.scam-guard.net,http://web.scam-guard.net
          
          app:
            ai:
              openrouter:
                api-key: ${{ secrets.OPENROUTER_API_KEY }}
                base-url: https://openrouter.ai/api
                model: deepseek/deepseek-r1-0528:free
            embedding:
              provider: gemini
              model-name: gemini-embedding-001
              dimensions: 3072
              chunk-size: 600
              chunk-overlap: 100
          
          spring.elasticsearch:
            uris: http://localhost:9200
            username: elastic
            password: ${{ secrets.ELASTIC_PASSWORD }}
          EOF

      - name: Build with Gradle
        run: ./gradlew clean build -x test

      # [중요] 빌드된 파일 중 실행 가능한 Jar만 남기고 이름을 app.jar로 변경
      - name: Rename JAR
        run: |
          # plain jar는 필요 없으므로 삭제 (혼동 방지)
          rm build/libs/*-plain.jar
          # 남은 실행 가능한 jar를 app.jar로 이름 변경
          mv build/libs/*.jar build/libs/app.jar

      - name: Get GitHub Actions IP
        id: ip
        uses: haythem/public-ip@v1.2

      - name: Add GitHub Actions IP to Security Group
        run: |
          aws ec2 authorize-security-group-ingress \
            --group-id ${{ secrets.AWS_SG_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr ${{ steps.ip.outputs.ipv4 }}/32
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ap-northeast-2

      - name: Wait for Security Group to Update
        run: sleep 10

      # 1. 기존 파일 정리 (SSH Action)
      - name: Clean up remote server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 60s
          script: |
            sudo systemctl stop scamguard || true
            # [중요] 기존에 잘못 생성된 디렉토리이건 파일이건 강제로 삭제
            sudo rm -rf /opt/scamguard/app.jar

      # 2. 파일 전송 (SCP Action)
      - name: Copy JAR to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          source: "build/libs/app.jar"
          target: "/opt/scamguard/app.jar"
          strip_components: 2

      # 3. 애플리케이션 시작 (SSH Action)
      - name: Start Application
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 60s
          script: |
            sudo chmod +x /opt/scamguard/app.jar
            sudo systemctl start scamguard
            sudo systemctl status scamguard --no-pager -l

      - name: Remove GitHub Actions IP from Security Group
        if: always()
        run: |
          aws ec2 revoke-security-group-ingress \
            --group-id ${{ secrets.AWS_SG_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr ${{ steps.ip.outputs.ipv4 }}/32
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ap-northeast-2
